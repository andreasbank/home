<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Home (mockup)</title>
  <link rel="stylesheet" href="style.css" type="text/css" />
  <script type="text/javascript" src="helpers.js"></script>
  <script type="text/javascript" src="classes.js"></script>
  <script type="text/javascript" src="ajax.js"></script>
</head>
<body>
<div id="gui"></div>
<script type="text/javascript">
  <!--

  var usersRequestIndicator = null;
  var usersPointer = null;
  var users = null;

  var portalsRequestIndicator = null;
  var portalsPointer = null;
  var portals = null;
  var visiblePortals = null;

  var bookingsRequestIndicator = null;
  var bookingsPointer = null;
  var bookings = null;

  var loggedInUserInfoRequestIndicator = null;
  var loggedInUserInfoPointer = null;
  var loggedInUser = null;

  var gui = new Gui();

  function callbackUsers(result_users) {
    users = result_users;
    if(null != portals && null != bookings) {
      gui.draw();
    }
  }

  function callbackPortals(result_portals) {
    portals = result_portals;
    if(null != users && null != bookings) {
      gui.draw();
    }
  }

  function callbackBookings(result_bookings) {
    bookings = result_bookings;
    if(null != users && null != portals) {
      gui.draw();
    }
  }

  function findBookedOwnPortals() {
    var bookedOwnPortals = new Array();
    for(var i = 0; i < bookings.length; i++) {
      if(bookings[i].getUser().id == loggedInUser.id) {
        bookedOwnPortals.push(bookings[i].getPortal());
      }
    }
    return bookedOwnPortals;
  }

  function getPortals() {
    portalsPointer = { innerObject: new Array() };
    portalsRequestIndicator = new RequestIndicator();
    ajaxXml('getPortals', 'responseType=xml', portalsRequestIndicator, portalsPointer, callbackPortals);
  }

  function getUsers() {
    usersPointer = { innerObject: new Array() };
    usersRequestIndicator = new RequestIndicator();
    ajaxXml('getUsers', 'responseType=xml', usersRequestIndicator, usersPointer, callbackUsers);
  }

  function getBookings() {
    bookingsPointer = { innerObject: new Array() };
    bookingsRequestIndicator = new RequestIndicator();
    ajaxXml('getBookings', 'responseType=xml', bookingsRequestIndicator, bookingsPointer, callbackBookings);
  }

  function callbackLoggedInUserInfo(result) {
    if(null == result) {
      removeCookie('axis-home');
      alert('Invalid session detected and removed, you need to log in again')
      window.location = './'
      return;
    }
    loggedInUser = result[0];
    loggedIn = document.getElementById('loggedInUserTag');
    if(null != loggedIn) {
      loggedIn.innerHTML = loggedInUser.fullName;
    }
  }

  function getLoggedInUserInfo() {
    loggedInUserInfoPointer = { innerObject: new Array() };
    loggedInUserInfoRequestIndicator = new RequestIndicator();
    ajaxXml('getLoggedInUserInfo', 'responseType=xml', loggedInUserInfoRequestIndicator, loggedInUserInfoPointer, callbackLoggedInUserInfo);
  }

  function createForm(method, action) {
    var form = document.createElement('form');
    form.setAttribute('method', method);
    form.setAttribute('action', action);
    return form;
  }

  function createInput(id, name, style, type, eventType, eventString, value) {
    var input = document.createElement('input');
    if(null != id) {
      input.setAttribute('id', id);
    }
    if(null != name) {
      input.setAttribute('name', name);
    }
    if(null != style) {
      input.setAttribute('style', style);
    }
    if(null == type) {
      type = 'text';
    }
    input.setAttribute('type', type);
    if(null != eventType && null != eventString) {
      input.setAttribute(eventType, eventString);
    }
    if(null == value) {
      value = '';
    }
    input.setAttribute('value', value);
    return input;
  }

  function Gui() {
    this.drawingInProggress = false;
    this.guiDiv = 'gui';
    this.visibleEnvironmentsId = 'visibleEnvironmentsId';
    this.visibleEnvironmentsId = 'ownEnvironmentsId';

    /**
     * Tells the drawing mechanism
     * that we have begun drawing.
     * Used to protect against multiple
     * calls to the draw() method.
     */
    this.beginDrawing = function () {
      this.drawingInProgress = true;
    };

    /**
     * Tells the drawing mechanism
     * that we have finished drawing.
     */
    this.finishDrawing = function () {
      this.drawingInProgress = false;
    };

    /**
     * Draws a login input form that can
     * be used to log in to the system.
     */
    this.drawLogin = function (targetDiv) {
      var form = createForm('post', 'api.php');
      var inputAction = createInput(null, 'action', null, 'hidden', null, null, 'doLogin');
      var inputUsername = createInput(null, 'username', null, null, null, null, null);
      var inputPassword = createInput(null, 'password', null, null, null, null, null);
      var inputLogin = createInput(null, null, 'height:100%;', 'submit', null, null, 'Login!');
      var table = document.createElement('table');
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      form.appendChild(inputAction);
      td.innerHTML = 'user:';
      tr.appendChild(td);
      td = document.createElement('td');
      td.appendChild(inputUsername);
      tr.appendChild(td);
      td = document.createElement('td');
      td.setAttribute('rowspan', '2');
      td.appendChild(inputLogin);
      tr.appendChild(td);
      table.appendChild(tr);
      tr = document.createElement('tr');
      td = document.createElement('td');
      td.innerHTML = 'pass:';
      tr.appendChild(td);
      td = document.createElement('td');
      td.appendChild(inputPassword);
      tr.appendChild(td);
      table.appendChild(tr);
      form.appendChild(table);
      document.getElementById(targetDiv).appendChild(form);
    }

    /**
     * Draws info about the logged in user.
     */
    this.drawLoginInfo = function (targetDiv) {
      var form = createForm('post', 'api.php');
      var p = document.createElement('p');
      var span = document.createElement('span');
      var inputAction = createInput(null, 'action', null, 'hidden', null, null, 'doLogout');
      var inputLogout = createInput(null, null, null, 'submit', null, null, 'Logout');
      p.innerHTML = 'Logged in as ';
      span.setAttribute('id', 'loggedInUserTag');
      if(null != loggedInUser) {
        span.innerHTML = loggedInUser.fullName;
      }
      else {
        span.innerHTML = '(fetching info...)';
      }
      p.appendChild(span);
      form.appendChild(p);
      form.appendChild(inputAction);
      form.appendChild(inputLogout);
      document.getElementById(targetDiv).appendChild(form);
    }

    /**
     * Draws a given array of Portal objects ass
     * a html table.
     */
    this.drawPortals = function (targetDiv, newId, portalsToDraw) {
      var tableEnvironments = null;
      var trEnvironments = document.createElement('tr');
      var tdEnvironment = null;
      for(var i = 0; i < portalsToDraw.length; i++) {
        if(i % 5 == 0) {
          if(null == tableEnvironments) {
            tableEnvironments = document.createElement('table');
            tableEnvironments.setAttribute('id', newId);
          }
          else {
            tableEnvironments.appendChild(trEnvironments);
            trEnvironments = document.createElement('tr');
          }
        }
        tdEnvironment = document.createElement('td');
        tdEnvironment.setAttribute('class', 'main_table_td');
        var table = document.createElement('table');
        table.setAttribute('class', 'env_box booked' + (null != portalsToDraw[i].getBooking() ? (portalsToDraw[i].isOwnBooking() ? '_own' : '') : '_none'));
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.setAttribute('colspan', '2');
        td.setAttribute('class', 'env_name');
        td.innerHTML = portalsToDraw[i].name;
        tr.appendChild(td);
        table.appendChild(tr);
        tr = document.createElement('tr');
        td = document.createElement('td');
        var hostsTable = document.createElement('table');
        for(var j = 0; j < portalsToDraw[i].hosts.length; j++) {
          var hostsTr = document.createElement('tr');
          var hostsTd = document.createElement('td');
          hostsTd.innerHTML = portalsToDraw[i].hosts[j];
          hostsTr.appendChild(hostsTd);
          hostsTable.appendChild(hostsTr);
        }
        td.appendChild(hostsTable);
        tr.appendChild(td);
        var inputAction = createInput(null, 'action', null, 'hidden', null, null, 'doBook');
        var inputPortal = createInput(null, 'portal_id', null, 'hidden', null, null, portalsToDraw[i].id);
        var inputBook = createInput(null, null, null, 'submit', null, null, 'Book!');
        td = document.createElement('td');
        td.setAttribute('rowspan', '2');
        td.appendChild(inputAction);
        td.appendChild(inputPortal);
        td.appendChild(inputBook);
        tr.appendChild(td);
        table.appendChild(tr);
        tr = document.createElement('tr');
        td = document.createElement('td');
        td.innerHTML = (portalsToDraw[i].getBooking() ? portalsToDraw[i].getBooking().getUser().fullName : '&nbsp;');
        tr.appendChild(td);
        table.appendChild(tr);

        tdEnvironment.appendChild(table);
        trEnvironments.appendChild(tdEnvironment);
        if(i + 1 == portalsToDraw.length) {
          tableEnvironments.appendChild(trEnvironments);
        }

      }

      var rootDiv = document.getElementById(targetDiv);
      var lastTableEnvironments = document.getElementById(newId);
      if(null != lastTableEnvironments) {
        rootDiv.removeChild(lastTableEnvironments);
      }
      if(null != tableEnvironments) {
        rootDiv.appendChild(tableEnvironments);
      }
    }

    /**
     * Draws Portal objects that the logged
     * in user has booked ass a html table.
     */
    this.drawOwnBookedPortals = function (targetDiv) {
      this.drawPortals(targetDiv, this.ownEnvironmentsId, findBookedOwnPortals());
    }

    /**
     * Draws all Portal objects fetched from
     * the database ass a html table.
     */
    this.drawAllPortals = function (targetDiv) {
      visiblePortals = portals;
      this.drawPortals(targetDiv, this.visibleEnvironmentsId, visiblePortals);
    }

    /**
     * Filter the environments array to be displayed
     */
    this.searchFilter = function (searchStringTag, portalsList) {
      var searchString = document.getElementById(searchStringTag).value.toLowerCase();
      if('' == searchString) {
        visiblePortals = portalsList;
        this.drawPortals(this.guiDiv, this.visibleEnvironmentsId, visiblePortals);
        return;
      }

      visiblePortals = new Array();

      for(var i = 0; i < portalsList.length; i++) {

        // search name
        if(portalsList[i].name.toLowerCase().indexOf(searchString) >= 0) {
          visiblePortals.push(portalsList[i]);
          continue;
        }

        // search hosts
        var hostsLoopFound = false;
        for(var j = 0; j < portalsList[i].hosts.length; j++) {
          if(portalsList[i].hosts[j].toLowerCase().indexOf(searchString) >= 0) {
            visiblePortals.push(portalsList[i]);
            hostsLoopFound = true;
            break;
          }
        }
        if(hostsLoopFound) {
          continue;
        }

        // search booked users username and fullName
        var portalBooking = portalsList[i].getBooking();
        if(portalBooking != null) {
          var portalBookingUser = portalBooking.getUser();
          if(portalBookingUser.username.toLowerCase().indexOf(searchString) >= 0 ||
             portalBookingUser.fullName.toLowerCase().indexOf(searchString) >= 0) {
            visiblePortals.push(portalsList[i]);
            continue;
          }
        }
      }
      this.drawPortals(this.guiDiv, this.visibleEnvironmentsId, visiblePortals);
    }

    //createInput(id, name, style, type, actiontype, onaction, value)
    this.drawSearchTool = function (targetDiv) {
      var table = document.createElement('table');
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      var inputSearch = createInput('searchFilter', null, null, null, 'onkeyup', 'javascript:gui.searchFilter(\'searchFilter\', portals);', null);
      var inputSearchLabel = document.createElement('label');
      inputSearchLabel.setAttribute('for', 'searchFilter');
      inputSearchLabel.innerHTML = 'Search filter: ';
      var inputRefresh = createInput('searchRefreshState', null, null, 'checkbox', 'onclick', 'javascript:gui.setSearchRefreshState();', '1');
      var inputRefreshLabel = document.createElement('label');
      inputRefreshLabel.setAttribute('for', 'searchRefreshState');
      inputRefreshLabel.innerHTML = 'Sync with server every 10 seconds';
      td.appendChild(inputSearchLabel);
      td.appendChild(inputSearch);
      td.appendChild(document.createElement('br'));
      td.appendChild(inputRefresh);
      td.appendChild(inputRefreshLabel);
      tr.appendChild(td);
      td = document.createElement('td');
      tr.appendChild(td);
      table.appendChild(tr);
      document.getElementById(targetDiv).appendChild(table);
    }

    /**
     * Draws the system GUI as a html page.
     */
    this.draw = function () {
      if(this.drawingInProgress) {
        return;
      }
      this.beginDrawing();

      this.drawLoginInfo(this.guiDiv);
      this.drawSearchTool(this.guiDiv);
      this.drawOwnBookedPortals(this.guiDiv);
      this.drawAllPortals(this.guiDiv);

      this.finishDrawing();
    }
  }

  var session_id = getCookie('axis-home');
  if(null != session_id) {
    getLoggedInUserInfo();
    getUsers();
    getPortals();
    getBookings();
  }
  else {
    gui.drawLogin(gui.guiDiv);
  }

  -->
</script>
</body>
</html>

