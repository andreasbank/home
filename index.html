<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Home (mockup)</title>
  <link rel="stylesheet" href="style.css" type="text/css" />
  <script type="text/javascript" src="helpers.js"></script>
  <script type="text/javascript" src="classes.js"></script>
  <script type="text/javascript" src="ajax.js"></script>
</head>
<body>
<script type="text/javascript">
  <!--

  var usersRequestIndicator = null;
  var usersPointer = null;
  var users = null;

  var portalsRequestIndicator = null;
  var portalsPointer = null;
  var portals = null;
  var bookedOwnPortals = null;

  var bookingsRequestIndicator = null;
  var bookingsPointer = null;
  var bookings = null;

  var loggedInUserInfoRequestIndicator = null;
  var loggedInUserInfoPointer = null;
  var loggedInUser = null;

  function callbackUsers(result_users) {
    users = result_users;
    if(null != portals && null != bookings) {
      drawGui();
    }
  }

  function callbackPortals(result_portals) {
    portals = result_portals;
    if(null != users && null != bookings) {
      drawGui();
    }
  }

  function callbackBookings(result_bookings) {
    bookings = result_bookings;
    if(null != users && null != portals) {
      drawGui();
    }
  }

  function findBookedOwnPortals() {
    var bookedOwnPortals = null;
    for(var i = 0; i < portals.length; i++) {
      if(portals[i].getBooking().user.id == loggedInUser.id) {
        bookedOwnPortals.push(portals[i]);
      }
    }
    return bookedOwnPortals;
  }

  function getPortals() {
    portalsPointer = { innerObject: new Array() };
    portalsRequestIndicator = new RequestIndicator();
    ajaxXml('getPortalsWithBookings', 'responseType=xml', portalsRequestIndicator, portalsPointer, callbackPortals);
  }

  function getUsers() {
    usersPointer = { innerObject: new Array() };
    usersRequestIndicator = new RequestIndicator();
    ajaxXml('getUsers', 'responseType=xml', usersRequestIndicator, usersPointer, callbackUsers);
  }

  function getBookings() {
    bookingsPointer = { innerObject: new Array() };
    bookingsRequestIndicator = new RequestIndicator();
    ajaxXml('getBookings', 'responseType=xml', bookingsRequestIndicator, bookingsPointer, callbackBookings);
  }

  function callbackLoggedInUserInfo(result) {
    if(null == result) {
      setCookie('axis-home', '', -1);
      alert('Invalid session detected and removed, you need to log in again')
      window.location = './'
      return;
    }
    loggedInUser = result[0];
    document.getElementById('loggedInUserTag').innerHTML = loggedInUser.fullName;
  }

  function getLoggedInUserInfo() {
    loggedInUserInfoPointer = { innerObject: new Array() };
    loggedInUserInfoRequestIndicator = new RequestIndicator();
    ajaxXml('getLoggedInUserInfo', 'responseType=xml', loggedInUserInfoRequestIndicator, loggedInUserInfoPointer, callbackLoggedInUserInfo);
  }

  function drawGui() {
    document.write("<p>Logged in as <span id=\"loggedInUserTag\">(fetching info...)</span></p>\n");
  }

  var session_id = getCookie('axis-home');
  if(null != session_id) {
    document.write("<p>Logged in as <span id=\"loggedInUserTag\">(fetching info...)</span></p>\n");
    document.write("\t<form method=\"post\" action=\"api.php\">\n");
    document.write("\t<input name=\"action\" type=\"hidden\" value=\"doLogout\" />\n");
    document.write("\t<input type=\"submit\" value=\"Logout!\">\n");
    document.write("</form>\n");
    getLoggedInUserInfo();
    getUsers();
    getPortals();
    getBookings();
  }
  else {
    document.write("<form method=\"post\" action=\"api.php\">\n");
    document.write("<input name=\"action\" type=\"hidden\" value=\"doLogin\" />\n");
    document.write("<table>\n");
    document.write("\t<tr>\n");
    document.write("\t\t<td>user:</td>\n");
    document.write("\t\t<td><input name=\"username\" type=\"text\" value=\"\" /></td>\n");
    document.write("\t\t<td rowspan=\"2\"><input style=\"height:100%;\" type=\"submit\" value=\"Login!\" /></td>\n");
    document.write("\t</tr>\n");
    document.write("\t<tr>\n");
    document.write("\t\t<td>pass:</td>\n");
    document.write("\t\t<td><input name=\"password\" type=\"password\" value=\"\" /></td>\n");
    document.write("\t</tr>\n");
    document.write("</table>\n");
    document.write("</form>\n");
  }

  -->
</script>
<div id="">
</div>
</body>
</html>

